<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FlowState</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 核心视觉定义 --- */
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-highlight: rgba(255, 255, 255, 0.1);
            --primary-glow: rgba(99, 102, 241, 0.4);
            --app-bg: #050505;
        }

        body {
            background-color: var(--app-bg);
            font-family: 'Inter', sans-serif;
            color: #f8fafc;
            overflow: hidden; /* 禁止滚动，用内部容器滚动 */
            -webkit-tap-highlight-color: transparent;
        }

        /* 动态极光背景 */
        .aurora-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 10%, #1e1b4b, transparent 60%),
                        radial-gradient(circle at 90% 60%, #312e81, transparent 50%),
                        radial-gradient(circle at 10% 50%, #0f172a, transparent 50%);
            background-size: 200% 200%;
            animation: auroraFlow 20s ease-in-out infinite alternate;
        }
        @keyframes auroraFlow {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* 玻璃拟态组件 */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .glass-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .glass-btn:active {
            transform: scale(0.96);
        }
        .glass-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        /* 液态气泡动画 */
        .liquid-bubble {
            animation: floatBubble 6s ease-in-out infinite;
            border: 1px solid rgba(255,255,255,0.1);
            background: radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.01) 100%);
            backdrop-filter: blur(8px);
        }
        @keyframes floatBubble {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.02); }
        }

        /* 呼吸灯按钮 (Unfreeze) */
        .panic-btn-glow {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            animation: pulse-blue 2s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-blue {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        /* 滑块样式自定义 */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px; width: 24px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-top: -10px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        /* 页面切换动画 */
        .fade-slide-enter-active, .fade-slide-leave-active {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .fade-slide-enter-from { opacity: 0; transform: translateY(20px) scale(0.98); }
        .fade-slide-leave-to { opacity: 0; transform: translateY(-20px) scale(0.98); }

        /* Markdown 样式微调 */
        .prose p { margin-bottom: 0.5rem; line-height: 1.6; }
        .prose strong { color: #e0e7ff; font-weight: 600; }
        
        /* 隐藏滚动条但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-screen flex flex-col relative overflow-hidden text-slate-200">
    
    <div class="aurora-bg"></div>

    <transition name="fade-slide">
        <div v-if="!apiKey || view === 'settings'" class="absolute inset-0 z-50 bg-black/80 backdrop-blur-xl flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md rounded-3xl p-8 transform transition-all">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-white tracking-tight">系统核心配置</h2>
                    <button v-if="apiKey" @click="view = 'home'" class="p-2 rounded-full hover:bg-white/10"><i data-lucide="x"></i></button>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">Gemini API Key</label>
                        <input type="password" v-model="tempKey" placeholder="sk-..." class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">选择模型 (Model)</label>
                        <div class="relative">
                            <select v-model="selectedModel" class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white appearance-none focus:outline-none focus:border-indigo-500">
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash (快速/经济)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro (更聪明/推荐)</option>
                                <option value="gemini-1.0-pro">Gemini 1.0 Pro (经典)</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-4 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">推荐使用 1.5 Pro 以获得最佳的“心理咨询”体验。</p>
                    </div>

                    <button @click="saveSettings" :disabled="!tempKey" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-indigo-900/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                        连接神经网络
                    </button>
                    
                    <div class="pt-4 border-t border-white/5 text-center">
                        <button @click="clearKey" v-if="apiKey" class="text-xs text-red-400 hover:text-red-300 transition">断开连接 / 清除数据</button>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <header v-if="apiKey" class="px-6 pt-12 pb-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex flex-col">
            <span class="text-xs text-indigo-300 font-medium tracking-widest uppercase mb-0.5">FlowState</span>
            <span class="text-lg font-semibold text-white">{{ greeting }}</span>
        </div>
        <button @click="view = 'settings'" class="w-10 h-10 rounded-full glass-btn flex items-center justify-center">
            <i data-lucide="sliders-horizontal" class="w-4 h-4 text-slate-300"></i>
        </button>
    </header>

    <main v-if="apiKey" class="flex-1 relative overflow-y-auto no-scrollbar px-4 pb-24">
        
        <transition name="fade-slide" mode="out-in">
            <div v-if="view === 'home'" key="home" class="flex flex-col gap-6 h-full justify-center pb-20">
                
                <div class="glass-panel rounded-3xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-indigo-500 to-purple-500"></div>
                    <h3 class="text-sm text-slate-400 mb-6">目前的能量状态？</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-500">身体能量</span>
                                <span :class="energyColor">{{ energyLevel }}%</span>
                            </div>
                            <input type="range" v-model="energyLevel" min="0" max="100" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-500">心情</span>
                                <span class="text-indigo-300">{{ moodText }}</span>
                            </div>
                            <input type="range" v-model="moodLevel" min="0" max="100" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-white/5 text-xs text-slate-400 italic">
                        {{ energyInsight }}
                    </div>
                </div>

                <div class="flex-1 flex items-center justify-center py-4">
                    <button @click="startPanicMode" class="relative group w-64 h-64 rounded-full flex flex-col items-center justify-center transition-transform active:scale-95">
                        <div class="absolute inset-0 rounded-full bg-indigo-500/20 blur-3xl group-hover:bg-indigo-500/30 transition-all duration-700 panic-btn-glow"></div>
                        <div class="relative z-10 glass-panel w-56 h-56 rounded-full flex flex-col items-center justify-center border border-indigo-500/30">
                            <i data-lucide="zap" class="w-10 h-10 text-indigo-300 mb-2"></i>
                            <span class="text-2xl font-bold text-white tracking-tight">解冻</span>
                            <span class="text-xs text-indigo-200/60 mt-1">我卡住了</span>
                        </div>
                    </button>
                </div>
            </div>

            <div v-else-if="view === 'schedule'" key="schedule" class="h-full">
                <div class="mb-6 flex justify-between items-end">
                    <h2 class="text-2xl font-bold">流体日程</h2>
                    <button @click="showAddTask = true" class="p-2 bg-indigo-600 rounded-xl text-white hover:bg-indigo-500 transition">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="flex flex-wrap content-start gap-4 h-full overflow-y-auto pb-32">
                    <div v-if="filteredTasks.length === 0" class="w-full text-center py-20 text-slate-500">
                        <p class="mb-2">水面很平静。</p>
                        <p class="text-xs opacity-50">享受这一刻的宁静，或者添加一个小气泡。</p>
                    </div>

                    <div v-for="task in filteredTasks" :key="task.id" 
                         @click="focusTask(task)"
                         class="liquid-bubble rounded-full flex items-center justify-center text-center p-4 cursor-pointer hover:bg-white/10 transition-colors relative"
                         :style="getBubbleStyle(task)">
                        <span class="font-medium text-sm leading-tight select-none">{{ task.title }}</span>
                        <div v-if="task.isUrgent" class="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full animate-ping"></div>
                    </div>
                </div>

                <div v-if="showAddTask" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4">
                    <div class="glass-panel w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up">
                        <h3 class="font-bold mb-4">放置一个新的气泡</h3>
                        <input v-model="newTaskTitle" placeholder="要做什么？" class="w-full bg-black/20 border border-white/10 rounded-xl p-4 text-white mb-4 outline-none focus:border-indigo-500">
                        
                        <div class="flex gap-2 mb-6">
                            <button @click="newTaskPriority = 'low'" :class="newTaskPriority === 'low' ? 'bg-blue-500/20 border-blue-500' : 'border-white/10'" class="flex-1 py-2 rounded-lg border text-xs">小气泡</button>
                            <button @click="newTaskPriority = 'medium'" :class="newTaskPriority === 'medium' ? 'bg-indigo-500/20 border-indigo-500' : 'border-white/10'" class="flex-1 py-2 rounded-lg border text-xs">中气泡</button>
                            <button @click="newTaskPriority = 'high'" :class="newTaskPriority === 'high' ? 'bg-orange-500/20 border-orange-500' : 'border-white/10'" class="flex-1 py-2 rounded-lg border text-xs">大气泡</button>
                        </div>

                        <div class="flex gap-3">
                            <button @click="showAddTask = false" class="flex-1 py-3 text-slate-400">取消</button>
                            <button @click="addTask" :disabled="!newTaskTitle" class="flex-1 bg-white text-black font-bold rounded-xl py-3 disabled:opacity-50">放入水中</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else-if="view === 'chat'" key="chat" class="flex flex-col h-full relative">
                <div ref="chatContainer" class="flex-1 overflow-y-auto px-2 pb-4 space-y-6">
                    <div v-for="(msg, index) in chatHistory" :key="index" :class="msg.role === 'user' ? 'items-end' : 'items-start'" class="flex flex-col">
                        <div :class="msg.role === 'user' ? 'bg-indigo-600 rounded-tr-sm' : 'glass-panel rounded-tl-sm'" class="max-w-[85%] rounded-2xl px-5 py-4 text-sm leading-relaxed shadow-lg">
                            <div v-if="msg.role === 'assistant'" v-html="renderMarkdown(msg.content)"></div>
                            <div v-else>{{ msg.content }}</div>
                        </div>
                    </div>
                    
                    <div v-if="isAiThinking" class="flex items-center gap-2 text-indigo-300 text-xs ml-4">
                        <i data-lucide="loader-2" class="animate-spin w-3 h-3"></i>
                        <span>Flow AI 正在思考最温柔的建议...</span>
                    </div>
                </div>

                <div class="glass-panel border-t-0 border-x-0 border-b-0 rounded-t-3xl p-4 mt-2">
                    
                    <div v-if="quickReplies.length > 0" class="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-2">
                        <button v-for="reply in quickReplies" @click="sendMessage(reply)" class="whitespace-nowrap px-4 py-2 rounded-full border border-indigo-500/30 bg-indigo-500/10 text-indigo-200 text-xs hover:bg-indigo-500/20 transition">
                            {{ reply }}
                        </button>
                    </div>

                    <div class="relative flex items-center gap-2">
                        <input v-model="userInput" @keyup.enter="sendMessage(userInput)" type="text" placeholder="输入你的想法..." class="flex-1 bg-black/30 border border-white/10 rounded-full px-5 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 transition shadow-inner">
                        <button @click="sendMessage(userInput)" :disabled="!userInput || isAiThinking" class="p-3 bg-indigo-600 rounded-full text-white hover:bg-indigo-500 disabled:opacity-50 transition shadow-lg shadow-indigo-900/40">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div v-else-if="view === 'focus'" key="focus" class="h-full flex flex-col items-center justify-center text-center px-6">
                <div class="mb-8">
                    <span class="text-indigo-400 text-xs font-mono uppercase tracking-widest mb-2 block">当前单一任务</span>
                    <h2 class="text-3xl font-bold leading-tight">{{ currentFocusTask?.title }}</h2>
                </div>

                <div v-if="!focusStarted" class="space-y-4 w-full max-w-xs">
                     <button @click="startFocusSession" class="w-full glass-btn py-4 rounded-2xl text-lg font-bold border-indigo-500/30 text-indigo-100">
                        开始 (仅 5 分钟)
                    </button>
                    <button @click="negotiateTask" class="w-full py-4 text-sm text-slate-400 hover:text-white transition">
                        太难了，我要和 AI 谈谈
                    </button>
                </div>

                <div v-else class="flex flex-col items-center">
                    <div class="text-6xl font-mono font-bold text-white mb-8 tracking-tighter">{{ formatTime(timeLeft) }}</div>
                    <p class="text-slate-400 text-sm mb-12">无论结果如何，2分钟后你都可以自由停止。</p>
                    
                    <button @click="completeFocus" class="bg-green-600 text-white px-10 py-4 rounded-full font-bold shadow-lg shadow-green-900/40 hover:bg-green-500 transition transform hover:scale-105">
                        完成第一步
                    </button>
                </div>
                
                <button @click="view = 'schedule'" class="absolute top-4 left-4 p-2 rounded-full glass-btn">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
            </div>

        </transition>
    </main>

    <nav v-if="apiKey && view !== 'settings' && view !== 'focus'" class="absolute bottom-6 left-6 right-6 h-16 glass-panel rounded-2xl flex justify-around items-center z-20 shadow-2xl">
        <button @click="view = 'home'" :class="view === 'home' ? 'text-indigo-400 scale-110' : 'text-slate-500'" class="transition-all duration-300 p-2">
            <i data-lucide="activity" class="w-6 h-6"></i>
        </button>
        <button @click="view = 'schedule'" :class="view === 'schedule' ? 'text-indigo-400 scale-110' : 'text-slate-500'" class="transition-all duration-300 p-2">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
        </button>
        <button @click="startPanicMode" :class="view === 'chat' ? 'text-indigo-400 scale-110' : 'text-slate-500'" class="transition-all duration-300 p-2">
            <i data-lucide="message-square" class="w-6 h-6"></i>
        </button>
    </nav>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- 核心数据 ---
            const apiKey = ref(localStorage.getItem('flow_api_key') || '');
            const tempKey = ref('');
            const selectedModel = ref(localStorage.getItem('flow_model') || 'gemini-1.5-pro');
            const view = ref('home'); // home, schedule, chat, settings, focus
            
            // --- 能量与心情 ---
            const energyLevel = ref(60);
            const moodLevel = ref(60);
            const energyInsight = computed(() => {
                if (energyLevel.value < 30) return "侦测到低电量模式。FlowState 将为你自动过滤掉 80% 的非必要任务。";
                if (moodLevel.value < 30) return "心情低落时，生产力不是重点。照顾好自己才是今天的任务。";
                return "状态不错。保持水一般的流动，不要强迫自己。";
            });
            const energyColor = computed(() => {
                if(energyLevel.value < 30) return 'text-red-400';
                if(energyLevel.value < 70) return 'text-orange-300';
                return 'text-green-400';
            });
            const moodText = computed(() => {
                if(moodLevel.value < 20) return "想躲在被子里";
                if(moodLevel.value < 50) return "有点焦虑";
                if(moodLevel.value < 80) return "平静";
                return "感觉很棒";
            });

            // --- 日程 / 气泡 ---
            const tasks = ref(JSON.parse(localStorage.getItem('flow_tasks') || '[]'));
            const showAddTask = ref(false);
            const newTaskTitle = ref('');
            const newTaskPriority = ref('medium');
            
            // 过滤逻辑：如果能量低，只显示小任务和紧急任务
            const filteredTasks = computed(() => {
                if (energyLevel.value < 30) {
                    return tasks.value.filter(t => t.priority === 'low' || t.isUrgent);
                }
                return tasks.value;
            });

            const addTask = () => {
                if(!newTaskTitle.value) return;
                tasks.value.push({
                    id: Date.now(),
                    title: newTaskTitle.value,
                    priority: newTaskPriority.value,
                    isUrgent: false,
                    completed: false
                });
                saveTasks();
                newTaskTitle.value = '';
                showAddTask.value = false;
            };

            const getBubbleStyle = (task) => {
                let size = '100px';
                if(task.priority === 'low') size = '80px';
                if(task.priority === 'high') size = '130px';
                
                // 随机微调位置，产生自然感
                const randomDelay = (task.id % 5) + 's';
                return {
                    width: size,
                    height: size,
                    animationDelay: randomDelay,
                    // 紧急任务带点红色光晕
                    boxShadow: task.isUrgent ? '0 0 20px rgba(249, 115, 22, 0.2)' : 'none'
                };
            };

            // --- 专注 / 计时器 ---
            const currentFocusTask = ref(null);
            const focusStarted = ref(false);
            const timeLeft = ref(300); // 5分钟
            let timerInterval = null;

            const focusTask = (task) => {
                currentFocusTask.value = task;
                view.value = 'focus';
                focusStarted.value = false;
            };

            const startFocusSession = () => {
                focusStarted.value = true;
                timeLeft.value = 300; // 5 mins
                timerInterval = setInterval(() => {
                    if(timeLeft.value > 0) timeLeft.value--;
                    else clearInterval(timerInterval);
                }, 1000);
            };

            const completeFocus = () => {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#6366f1', '#a855f7', '#ec4899'] });
                tasks.value = tasks.value.filter(t => t.id !== currentFocusTask.value.id);
                saveTasks();
                clearInterval(timerInterval);
                setTimeout(() => view.value = 'schedule', 1500);
            };

            const negotiateTask = () => {
                // 带着任务跳转去聊天
                startPanicMode(`我不想做 "${currentFocusTask.value.title}"，我觉得太难了。`);
            };

            // --- 聊天 / AI ---
            const chatHistory = ref([]);
            const userInput = ref('');
            const isAiThinking = ref(false);
            const quickReplies = ref([]);
            const chatContainer = ref(null);

            const SYSTEM_PROMPT = `你不是一个助手，你是一个极度温柔、富有同情心的CBT（认知行为疗法）治疗师和谈判专家。
            你的核心理念：
            1. "拒绝羞耻感"：用户没做完任务是正常的，不要责怪。
            2. "只关注第一步"：将任务切碎到荒谬的小（例如："只是站起来"）。
            3. "情绪先行"：先处理情绪，再处理任务。
            
            当用户说"我不想做"时，你要进行"谈判"，例如："那我们只做2分钟？" 或者 "我们只做最简单的一步？"。
            请用简短、口语化、温暖的中文回答。
            不要长篇大论。一次只给一个建议或一个问题。
            如果用户面临DDL，告诉他们："我们只需要写个标题，不用写完。"
            `;

            const startPanicMode = (initialMsg = null) => {
                view.value = 'chat';
                chatHistory.value = []; // 清空之前的对话
                quickReplies.value = ['我不知道做什么', '我很焦虑', '我不想动'];
                
                // 初始问候
                chatHistory.value.push({
                    role: 'assistant',
                    content: "深呼吸。我现在就在这里。无论发生什么都没关系。<br>怎么了？是卡住了，还是单纯觉得累？"
                });

                if (initialMsg) {
                    userInput.value = initialMsg;
                    sendMessage(initialMsg);
                }
            };

            const sendMessage = async (content) => {
                if (!content) return;
                
                // 用户消息
                chatHistory.value.push({ role: 'user', content: content });
                userInput.value = '';
                quickReplies.value = []; // 清除建议
                isAiThinking.value = true;
                scrollToBottom();

                try {
                    // 构建 API 请求
                    const historyForApi = chatHistory.value.map(m => ({
                        role: m.role === 'assistant' ? 'model' : 'user',
                        parts: [{ text: m.content }]
                    }));

                    // 插入 System Prompt (Gemini API 方式略有不同，这里用简单的 User 预设方式，或者 system instruction 如果模型支持)
                    // 为了兼容性，我们将 System Prompt 放在最前面作为 user 消息，或者使用 systemInstruction 字段 (beta)
                    
                    const payload = {
                        contents: historyForApi,
                        systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                    };

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel.value}:generateContent?key=${apiKey.value}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);

                    const aiText = data.candidates[0].content.parts[0].text;
                    
                    chatHistory.value.push({ role: 'assistant', content: aiText });
                    
                    // 简单的意图识别，生成 Quick Replies (本地模拟)
                    if (aiText.includes("洗澡")) quickReplies.value = ["只冲 3 分钟", "只洗脸"];
                    if (aiText.includes("第一步")) quickReplies.value = ["我可以做到", "还是太难"];

                } catch (e) {
                    chatHistory.value.push({ role: 'assistant', content: `<span class="text-red-300">连接断开了...但这不怪你。可能是网络问题。(${e.message})</span>` });
                } finally {
                    isAiThinking.value = false;
                    scrollToBottom();
                }
            };

            // --- 工具函数 ---
            const saveSettings = () => {
                localStorage.setItem('flow_api_key', tempKey.value);
                localStorage.setItem('flow_model', selectedModel.value);
                apiKey.value = tempKey.value;
                view.value = 'home';
            };
            
            const clearKey = () => {
                localStorage.removeItem('flow_api_key');
                apiKey.value = '';
            };

            const saveTasks = () => localStorage.setItem('flow_tasks', JSON.stringify(tasks.value));

            const scrollToBottom = () => {
                nextTick(() => {
                    if (chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                });
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m}:${sec < 10 ? '0'+sec : sec}`;
            };
            
            const renderMarkdown = (text) => marked.parse(text);

            const greeting = computed(() => {
                const hour = new Date().getHours();
                if(hour < 6) return "凌晨好，还不睡吗？";
                if(hour < 12) return "早安";
                if(hour < 18) return "下午好";
                return "晚上好";
            });

            // 初始化图标
            onMounted(() => {
                lucide.createIcons();
                // 自动载入之前的 Key
                if (apiKey.value) tempKey.value = apiKey.value;
            });
            
            // 视图切换时刷新图标
            watch(view, () => nextTick(() => lucide.createIcons()));
            watch(showAddTask, () => nextTick(() => lucide.createIcons()));

            return {
                apiKey, tempKey, selectedModel, view, saveSettings, clearKey,
                energyLevel, moodLevel, energyInsight, energyColor, moodText,
                tasks, filteredTasks, showAddTask, newTaskTitle, newTaskPriority, addTask, getBubbleStyle,
                currentFocusTask, focusStarted, timeLeft, focusTask, startFocusSession, completeFocus, negotiateTask, formatTime,
                chatHistory, userInput, sendMessage, isAiThinking, startPanicMode, quickReplies, chatContainer, renderMarkdown, greeting
            };
        }
    }).mount('#app');
</script>
</body>
</html>
